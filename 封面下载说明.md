# 封面下载分离说明

## 概述
已将封面下载功能从 `准备资源.py` 中分离到独立的 `下载封面.py` 脚本中，并完全移除了资源准备脚本中的网络请求功能。

## 使用方法

### 1. 运行资源准备脚本
```bash
python 准备资源.py --mode [daily-text|weekly|monthly|month-review|special]
```

### 2. 下载封面
脚本运行后会生成以下文件：
- `新增封面.json` - 包含需要下载的普通封面BV号和URL列表
- `特殊封面.json` - 包含特殊封面的URL（如果有的话）

然后运行封面下载脚本：
```bash
python 下载封面.py
```

## 功能说明

### 准备资源.py 的变化（纯本地处理）

#### 🚫 网络请求完全移除
- **移除 `get_thumbnail()` 函数**: 不再通过B站API获取封面URL
- **移除相关导入**: `asyncio`、`bilibili_api`、`requests`、`PIL` 等网络相关库
- **使用现有数据**: 统一使用数据文件中的 `image_url` 字段
- **静默处理**: 缺少URL时给出警告并跳过，不阻塞流程

#### 📋 数据收集功能
- `local_thumbnails()` - 收集需要下载的普通封面BV号和URL
- `cover_thumbnail()` - 输出特殊封面URL到JSON文件
- `million_reach()` - 处理百万达成相关的封面URL
- `achievements()` - 处理成就相关的封面URL
- `local_videos()` - 输出需要下载的视频URL列表（不实际下载）

#### 🛡️ 错误处理
- **URL缺失警告**: 当 `image_url` 为空时给出明确提示
- **优雅跳过**: 单个项目失败不影响整体流程
- **完整日志**: 清晰显示处理进度和结果

### 下载封面.py 增强功能

#### 🛡️ 防阻止机制
- **随机User-Agent**: 模拟多种真实浏览器
- **请求头伪装**: 完整的浏览器请求头信息
- **重试机制**: 最多3次重试，失败时自动更换UA
- **请求限制**: 限制并发数量（最多5个同时下载）
- **随机延迟**: 避免请求过于频繁

#### 📦 下载功能
- 支持批量下载普通封面（352x199，16:9比例）
- 支持下载特殊比例封面（1920x1440的4:3和1920x1080的16:9）
- 自动创建必要的文件夹（封面/、其他图片/）
- **流式下载**: 适合大文件下载
- **图片验证**: 下载后验证图片完整性
- **优化保存**: 使用高质量重采样和PNG优化

#### 📊 进度和错误处理
- **实时进度**: 显示下载进度和耗时统计
- **失败记录**: 自动记录下载失败的BV号到 `下载失败的封面.json`
- **详细错误**: 提供具体的错误信息和堆栈跟踪
- **分批处理**: 大量下载时分批进行，避免系统负载过高

## 输出文件

### 准备资源.py 输出
- `新增封面.json` - 普通封面下载列表
- `特殊封面.json` - 特殊封面URL
- `百万达成.json` - 百万达成数据
- `成就.json` - 成就数据
- `urls.txt` - 视频下载URL列表

### 下载封面.py 输出
- 普通封面保存在：`封面/[BV号].png`
- 特殊封面保存在：
  - `其他图片/最高新曲封面4比3.png`
  - `其他图片/最高新曲封面16比9.png`
- 失败记录：`下载失败的封面.json`（如果存在失败下载）

## 优势

### 🚀 性能提升
- **快速处理**: 资源准备脚本不再等待网络请求
- **并行操作**: 数据处理和网络下载可同时进行
- **本地优先**: 优先使用已有数据，减少不必要的网络调用

### 🔧 维护便利
- **职责分离**: 数据处理和网络下载完全解耦
- **独立调试**: 下载问题可独立排查和修复
- **灵活扩展**: 可根据需要选择性地执行下载步骤

## 技术细节

### User-Agent 列表
包含最新的 Chrome、Firefox 等主流浏览器User-Agent，定期轮换使用。

### 请求头信息
完整的浏览器请求头，包括：
- Accept 系列头部
- Sec-Fetch 系列头部
- Referer 指向B站
- Connection 保持连接

### 重试策略
- 指数退避延迟：每次重试等待时间递增
- 自动更换User-Agent
- 流式下载支持

### 图片处理
- 使用 `Image.Resampling.LANCZOS` 高质量重采样
- PNG格式优化保存
- 自动验证图片完整性
- 精确的浮点数坐标裁剪